[gcode_macro home]
gcode:
    G28                 # home axis
    Z_TILT_ADJUST       # adjust tilt
    G28 Z               # rehome z
    BED_MESH_CALIBRATE  # calibrate mesh
    DETACH_PROBE        # make sure probe is detached due to delayed_detach


[gcode_macro print_start]
gcode:

    {% set EXTRUDER = params.EXTRUDER|default(260) %}
    {% set BED = params.BED|default(110) %}
    print_reset
    M140 S{BED}         # set bed temp, don't wait
    M104 S{EXTRUDER}    # set extruder temp, don't wait

    G28                 # home axis, we're gonna move to 90,90,30
    G1 X90 Y90 Z30      # Move
    M84                 # no point in leaving motors on

    
    M109 S{EXTRUDER}    # set extruder temp, wait
    M190 S{BED}         # set bed temp, wait
    {% if printer["temperature_sensor chamber"].temperature < 45 %}
        G4 S600             # Wait 10 minutes, if chamber is lower than 45
    {% endif %}

    HOME                # home/mesh all the things
    G1 X90 Y90 Z5       # after detach move back to center
    
    
    purge TEMPERATURE={EXTRUDER} # purge

[gcode_macro print_reset]
gcode:
    M104 S0      # turn off bed
	M107         # turn off part fans
	G90          # use absolute coordinates
	M83	         # use relative extrusion
	G92 E0.0     # reset e count

[gcode_macro print_end]
gcode:
    G91                 # Relative positioning
    G1 E-2 F2700        # Retract a bit
    G1 E-2 Z0.2 F2400   # Retract and raise Z
    G1 E-5 F400         # yolo retract
    G1 X5 Y5 F3000      # Wipe out
    G1 Z10              # Raise Z more
    G90                 # Absolute positioning

    G1 X0 Y150  # Move Toolhead Away
    M106 S0     # Turn-off fan
    M104 S0     # Turn-off hotend
    M140 S0     # Turn-off bed

    M84     # Motors off
